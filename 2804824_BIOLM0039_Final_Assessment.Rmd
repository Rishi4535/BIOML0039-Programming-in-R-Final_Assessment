---
title: "2804824_BIOLM0039_Final_Assessment"
author: "Raja Rishi Raghavendar R- 2804824"
date: "2025-12-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
For this analysis pipeline, we were given a data set, which contains information regarding Giraffes in Africa, their recorded body masses along with environmental data which pertains to their habitat, predator presence etc. Our job is to figure out which of these environmental factors affect the body mass of giraffes using statistical modelling. 


# Methodology

### 1. Loading required libraries for analysis

```{r, results='hide', message=FALSE, warning=FALSE}
library(vroom)
library(dplyr)
library(tidyr)
library(Hmisc)
library(ggplot2)
library(ggpubr)
library(readxl)
library(rstatix)
library(dplyr)
library(performance)
library(fitdistrplus)
library(effectsize)
library(car)
library(lme4)
library(ggeffects)
library(DHARMa)
library(lattice)
library(forcats)
library(skimr)
library(knitr)
library(kableExtra)
```

### 2. Introducing our data

```{r, results='hide', message=FALSE, warning=FALSE}
#Setting up our working directory
setwd("C:/Rproject")
#listing the files in our working directory
files <- fs::dir_ls(path="C:/Rproject/mass_lv25974")
#listing files in the folder
files
#loading in the given data for analysis
analysis_data <- vroom(files, id="C:/Rproject/mass_lv25974/mass_lv25974.tsv")
```

### 3. Cleaning our data
Our data has a lot of duplicate values and unnecessary columns which are not required for our analysis, so before moving on to fitting a distribution and model, we need to clean the data to get the best results. So we first explore our given data, find out ambiguous values which need to be corrected or deleted to keep our data homogeneous for analysis. 

```{r}
describe(analysis_data)
```

```{r}
#cleaning our data by getting rid of unnecessary columns
analysis_data$`C:/Rproject/mass_lv25974/mass_lv25974.tsv`<-NULL
analysis_data$`student_id`<-NULL
#Modifying data entries to keep data homogenous
analysis_data$lion_presence[analysis_data$lion_presence=="Asbent"]<-"Absent"
analysis_data$lion_presence[analysis_data$lion_presence=="Preesnt"]<-"Present"
analysis_data$lion_presence[analysis_data$lion_presence=="Preseet"]<-"Present"
```

### 4. Transforming our data
As per the given instructions, sequential triplicates of data are considered to be of the same individual. So the most appropriate step would be to pivot our table, by creating new data columns using the environmental variable headers given and matching them with their subsequent values in the next column. 

```{r}
transformed_data <- analysis_data %>%
  pivot_wider(
    id_cols     = 1:7,        # retain first 7 columns exactly
    names_from  = 8,         # column with 3 specific entries
    values_from = 9          # column with values to assign
  )
```
After transformation of our data, we can look at the the new data frame: 
```{r, echo=FALSE}
#summarizing our transformed data
skimr::skim(transformed_data)
```
Look at how the body mass of Giraffes have been distributed over the data frame: 
```{r, echo=FALSE}
#visualizing our transformed data
hist(transformed_data$body_mass)
```

### 5. Creating a new dataframe from transformed one, for model fit
So now, we have transformed our data into something that we can use to fit a model and predict our body mass trends of giraffes, but we still need to pre-process this data. As we can see, as illustrated by the previous histogram, the data is extremely right skewed. Certain observed weights of Giraffes cannot be true, as the maximum recorded weight of giraffe is around 2 tonnes (source;https://www.bornfree.org.uk/animals/giraffes/). So we have to remove these values and then factorize categorical variables so that our statistical model does not consider them as predictor variables which will lead to a lot of errors and issues with our model. 

```{r, results='hide', message=FALSE, warning=FALSE}
#creating a new data set for model fit and analysis
#re-assigning NA as unknowns so model will still consider these values and not ignore them wile modelling
df <- transformed_data %>%
  mutate(
    landscape = fct_explicit_na(landscape, na_level = "Unknown"),
    vegetation = fct_explicit_na(vegetation, na_level = "Unknown"),
    lion_presence = fct_explicit_na(lion_presence, na_level = "Unknown")
  )

#indicating categorical variables so they are not taken as numerical values for modelling
df <- df %>%
  mutate(
    park = factor(park),
    observer = factor(observer),
    landscape = factor(landscape),
    vegetation = factor(vegetation),
    lion_presence = factor(lion_presence)
  )

#missing data in predictor variables should not be deleted, rather imputed with median of the data column to preserve data
df <- df %>%
  mutate(
    across(
      c(distance_to_water_km, average_annual_rainfall_mm, predator_density_per_sq_km),
      ~ ifelse(is.na(.x), median(.x, na.rm = TRUE), .x)
    )
  )

#removing outliers, body mass > 2000kg as maximum recorded weight of giraffe is around 2000kg
df <- df %>%
  filter(body_mass <= 2000)

#log of body mass is taken as extra data point for modelling analysis if required
df <- df %>%
  mutate(log_body_mass = log(body_mass))
```

Looking at our data and interacting with it to see how the data is structured 

```{r}
DT::datatable(df)
skimr::skim(df)
```


Now, in this, we can look at how the body mass is distributed: 


```{r, echo=FALSE}
hist(df$body_mass)
```

From this graph, we can say that the biologically true and observed values are distributed normally over our data, which we can deduce just by looking at our bell shaped distribution. 

### 6. Visualising how body mass is affected by catgeorical variables and environmental variables fore prediction

So, now using this data frame, we can plot graphs which show us the distribution of giraffes according to their body masses across various factors. 

```{r, message=FALSE, warning=FALSE}
#visualization of body mass across various categorical variables or factors
factor_vars <- df %>%
  select_if(where(is.factor)) %>%
  names()
#plotting
for (var in factor_vars) {
  
  p <- ggplot(df, aes_string(x = var, y = "body_mass")) +
    geom_jitter(width = 0.15, alpha = 0.5) +
    stat_summary(fun = mean, geom = "point", size = 4, colour = "red") +
    labs(
      x = var,
      y = "Body mass (kg)",
      title = paste("Giraffe body mass across", var)
    ) +
    theme_bw()
  
  print(p)
}


#visualisation of body mass over environmental/ predictor variables
ggplot(df, aes(x = distance_to_water_km, y = body_mass)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  labs(
    x = "Distance to water (km)",
    y = "Body mass (kg)",
    title = "Relationship between body mass and distance to water"
  )

ggplot(df, aes(x = average_annual_rainfall_mm, y = body_mass)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  labs(
    x = "Average annual rainfall (mm)",
    y = "Body mass (kg)",
    title = "Relationship between body mass and average annual rainfall"
  )

ggplot(df, aes(x = predator_density_per_sq_km, y = body_mass)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +
  theme_bw() +
  labs(
    x = "Predator Density (sq.km)",
    y = "Body mass (kg)",
    title = "Relationship between body mass and Predator Density"
  )
```

As we can see from the above visualizations, our body mass data is affected by observers, park, vegetation type, landscape type and presence of lions, and are not individual observations. So this enforces us to use a linear mixed effects model for our data, as visual inspection showed clear differences in average body mass among parks and observers, justifying the inclusion of random intercepts. 

### 7. Fitting a distribution over our data

Fitting a distribution over our data allows us to indicate the underlying patter of variation in the data and allows us to test our assumptions. Using this we can evaluate whether the data follows a Gaussian distribution and thereby justify the use of our selected statistical model, linear mixed effects.

```{r}
#fitting a distribution over our data
f_norm <- fitdist(df$body_mass, "norm")
gofstat(f_norm)
plot(f_norm)
```

From these plots and the statistical information we can confidently say that, a Gaussian distribution fits perfectly over our data with little to no exception cases, especially looking at our Q-Q plots. 

### 8. Fitting a model over our data 

Now, we have to carefully fit our data with a statistical model which can give us which variable or factor plays a major role in governing body mass of our ungulate species, in this case, Giraffes, by having it predict body masses for these variables/ factors. 

```{r}
#fitting a model on our data to get predictions
m1 <- lmer(
  body_mass ~ landscape + vegetation +
    distance_to_water_km + average_annual_rainfall_mm +
    predator_density_per_sq_km + lion_presence +
    (1 | park) + (1 | observer),
  data = df,
  REML = FALSE
)
```

```{r, message=FALSE, warning=FALSE}
#model summary and fit evaluation
summary(m1)
standardize_parameters(m1)
plot(m1)
qqnorm(resid(m1))
qqline(resid(m1))
check_predictions(m1)
```

These graphs show how well our model performs with its predictions on the basis of our data. The highlight of these graphs being the "posterior predictive check" graphs as it shows us that the observed data and the model predicted data overlap with each other very well. Now to qualitatively check our model, we can perform DHARMa tests which can check the fit of models and validate it. 

```{r, warning=FALSE}
# Check assumptions with DHARMa
sim_res <- simulateResiduals(m1, plot = FALSE)
plot(sim_res)  # residual diagnostics 
testDispersion(m1, plot = TRUE)
testOutliers(m1, plot = TRUE)
```

From the above DHARMa test graphs, we can see that our model fits very well with our data. 

### 9. Plotting predictions against factors to see how they affect the body mass of Giraffes

Now, using the prediction data from our models, we can check how these environmental variables like distance to water source, predator density and annual rainfall affect the body mass of Giraffes. 

```{r}
#predictions
pred <- ggpredict(m1, terms = "distance_to_water_km")
plot(pred) +
  labs(
    x = "Distance to Water (Km)",
    y = "Predicted body mass",
    title = "Distance to water sources effect on giraffe body mass"
  ) +
  theme_bw()

#predictions
pred <- ggpredict(m1, terms = "average_annual_rainfall_mm")
plot(pred) +
  labs(
    x = "average_annual_rainfall_mm",
    y = "Predicted body mass",
    title = "Effect of Rainfall on giraffe body mass"
  ) +
  theme_bw()

#predictions
pred <- ggpredict(m1, terms = "predator_density_per_sq_km")
plot(pred) +
  labs(
    x = "predator_per_sq_km",
    y = "Predicted body mass",
    title = "Effect of Predator density on giraffe body mass"
  ) +
  theme_bw()
```

## Interpretation of model predictions

So from our modelling of our data using a linear mixed effects model and visualizing its predictions across various factors, we can safely interpret the predictions and modelling data as follows: 

1. Body mass of Giraffes is positively affected by the distance between the animal and a water source i.e, Giraffes are more likely to weigh heavier if they are significantly more far form water sources 

2. Body mass of Giraffes are negatively affected by the amount of annual rainfall i.e, Giraffes are more likely to weigh less at areas with increased rainfall

3. The body mass of Giraffes does not depend upon the density of predators at any degree.

## Observations and Conclusions 

So, from this data analysis activity, we can take away that modelling over ecological data requires a lot of pre-processing and testing to find and fit the correct model over our data, so we can get meaningful predictions form them for a given basis, in this case body mass of Giraffes. 

Ecological Observations from analysis: 

1. Giraffe body masses remain more or less distributed equally across parks, landscapes and vegetation. 

2. Even across habitats which were demarcated on the basis of lion presence, there does not seems to be any change in distribution of body mass of Giraffes

3. Across observers, there does seem to be noticeable differentiation in the distribution of body masses. This can be due to bias, human error, which cannot be accounted for in this analytical exercise. 

4. The relation ship between body mass and predator density reveals another fact totally unrelated to body mass of Giraffes. By observing the graph and data points in that graph, we can say that Giraffes tend to be in places with less predator density. 

5. The body ass of Giraffes is directly proportional to distance of water source, inversely proportional to the annual rainfall and predator density has no effect on its body mass. 

